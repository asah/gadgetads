<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="__UP_title__"
    title_url="http://www.google.com/apis/gadgets/gs.html#Scratchpad"
    directory_title="Gadget Ads Scratch Pad"
    description="Load source code of gadgets by URL into a simple text editor, make changes, and preview the gadget on the fly."
    author="Daniel L."
    author_email="daniel.feedback+scratchpad@gmail.com"
    author_affiliation="Google Inc."
    author_location="Mountain View, CA"
    screenshot="http://www.google.com/ig/modules/scratchpad.png"
    thumbnail="http://www.google.com/ig/modules/scratchpad-thm.png"
    height="460"
    scaling="false"
    singleton="false">
    <Require feature="tabs"/>
    <Require feature="minimessage"/>
    <Require feature="setprefs"/>
    <Require feature="dynamic-height"/>
  </ModulePrefs>
  <UserPref name="title" display_name="Title" datatype="string" default_value="Gadget Scratch Pad"/>
  <UserPref name="height" display_name="Height" datatype="enum" default_value="350">
    <EnumValue value="200" display_value="smallest"/>
    <EnumValue value="250" display_value="smaller"/>
    <EnumValue value="300" display_value="small"/>
    <EnumValue value="350" display_value="normal"/>
    <EnumValue value="400" display_value="large"/>
    <EnumValue value="450" display_value="larger"/>
    <EnumValue value="500" display_value="largest"/>
  </UserPref>
  <UserPref name="fontSize" display_name="Font Size" datatype="string" default_value="0.75em"/>
  <UserPref name="currentUrl" datatype="hidden" default_value="http://www.google.com/ig/modules/hello.xml"/>
  <Content type="html"><![CDATA[
  <style>
  <!--
  .tablib_selected__MODULE_ID__, .tablib_unselected__MODULE_ID__ {
    width: 45%;
  }
  .tablib_spacerTab__MODULE_ID__ {
    width: 2px;
  }

  #inputContainer input {
    font-size: 11px;
  }

  #editTab form {
    margin: 0px;
    padding: 0px;
  }
  #editTab textarea {
    color: #000000;
    font-family: "Courier New", Courier;
    background-color: #eeeeee;
    border: 1px solid #676767;
    border-top-width: 0px;
    padding: 3px;
    overflow: auto;
    font-size: __UP_fontSize__;
    width: 100%;
    height: __UP_height__px;
  }

  #previewTab {
    border: 1px solid #676767;
    border-top-style: none;
    text-align: center;
    height: __UP_height__px;
  }
  #previewTab div {
    border: 1px dotted #676767;
    margin: 0px auto;
    overflow: auto;
  }

  #linkContainer {
    font-size: 10px;
    font-weight: bold;
  }
  #linkContainer a {
    color: #0000cc;
  }
  #statusContainer {
    height: 15px;
  }
  -->
  </style>

  <!-- ////////////////// HTML Content ////////////////// -->
  <div id="editTab">
    <form name="preview" method="post" target="previewFrame">
      <textarea id="rawxml" name="rawxml"></textarea>
    </form>
  </div>
  <div id="previewTab">
    <div id="previewDiv"><iframe id="previewFrame" name="previewFrame" frameborder=0></iframe></div>
  </div>

  <div id="inputContainer">
    <table width=100% border=0 cellspacing=0 cellpadding=0>
    <tr>
      <td><input style="width:100%;" id="moduleUrl" type="text" value=""/></td>
      <td width=20 align=right><input onclick="loadEditor(_gel('moduleUrl').value);" type="button" value="Load"/></td>
    </tr>
    </table>

    <div id="linkContainer"></div>
    <div id="statusContainer"></div>
  </div>

  <!-- ////////////// JavaScript /////////////////// -->
  <script>
  // Global constants
  var gadgetLinks = {
    "http://www.google.com/ig/modules/hello.xml": "Hello World",
    "http://gadgetads.googlecode.com/svn/trunk/template_flash.xml": "Sample Template",
    "http://gadgetads.googlecode.com/svn/trunk/sample_map.xml": "Sample Map",
    "http://gadgetads.googlecode.com/svn/trunk/sample_ait.xml": "Sample Interaction Tracking",
    "http://gadgetads.googlecode.com/svn/trunk/sample_youtube_flv.xml": "Sample YouTube Streaming",
    "http://gadgetads.googlecode.com/svn/trunk/simple_gmail_ad.xml": "Simple Gmail Gadget",
    "http://www.labpixies.com/gadgads/gmail/gmail.xml": "Gmail Gadget",
    "http://www.labpixies.com/gadgads/aa/aa_ie_link.xml": "American Airlines",
    "http://www.labpixies.com/campaigns/fox/fox.xml": "Fox Home Entertainment",
    "http://www.labpixies.com/gadgads/hp_simple/hp_simple.xml": "Hewlett Packard",
    "http://www.labpixies.com/gadgads/eclips/eclips.xml": "Eclipse",
    "http://flash.atlrec.com/google/diddy/diddy.xml": "Diddy TV",
    "http://www.google.com/ig/modules/mapsearch.xml": "Google Map Search",
    "http://www.google.com/ig/modules/driving_directions.xml": "Driving Directions",
    "http://ralph.feedback.googlepages.com/googlemap.xml": "Google Map",
    "http://gadgetads.googlecode.com/svn/trunk/vw/vw_ad.xml": "VW (example)"
  };

  // Global variables
  var tabs = new _IG_Tabs(__MODULE_ID__, "Edit");
  var mini = new _IG_MiniMessage(__MODULE_ID__, _gel("statusContainer"));
  var prefs = new _IG_Prefs(__MODULE_ID__);
  var defWidth = 320;
  var defHeight = prefs.getInt("height") - 2;   // Subtract 2 for borders

  function init() {
    tabs.addTab("Edit", "editTab");
    tabs.addTab("Preview", "previewTab", previewGadget);

    generateGadgetLinks();
    loadEditor(prefs.getString("currentUrl"));
    _IG_AdjustIFrameHeight();
  }

  function previewGadget() {
    document.forms["preview"].action = getGadgetUrl("rawxml");
    document.forms["preview"].submit();
  }

  function loadEditor(url) {
    _IG_FetchContent(url, _IG_Callback(loadEditorCallback, url, { refreshInterval: 0 }));
  }

  function loadEditorCallback(response, url) {
    if (response == "" || response.match(/Module/) == null) {
      mini.createTimerMessage("<span style='color:#dd0000; text-align:center;'>Module does not exist.</span>", 3);
    } else {
      prefs.set("currentUrl", url);
      _gel("moduleUrl").value = url;
      _gel("rawxml").value = response;
    }

    if (tabs.getSelectedTab().getIndex() == 1) {
      previewGadget();
    }
  }

  function generateGadgetLinks() {
    var html = new Array();
    for (var url in gadgetLinks) {
      html.push('<a href="javascript:void(0);" onclick="loadEditor(\'' + url + '\');">' + gadgetLinks[url] + '</a>');
    }
    _gel("linkContainer").innerHTML = html.join('&nbsp;|&nbsp;');
  }

  function getGadgetPrefs(spec) {
    var mpSpec = spec.substring(0, spec.search(/<(?:UserPref|Content)/));

    var title = mpSpec.match(/title="([^"]*)"/);
    title = (title) ? RegExp.$1 : "";
    var width = mpSpec.match(/width="(\d+)"/);
    width = (width) ? RegExp.$1 : defWidth;
    var height = mpSpec.match(/height="(\d+)"/);
    height = (height) ? RegExp.$1 : defHeight;

    return {
      "title" : title,
      "width" : Number(width),
      "height" : Number(height)
    }
  }

  function getGadgetUrl(id) {
    var spec = getGadgetSpec(id);
    var modulePrefs = getGadgetPrefs(spec);

    // Set preview container dimensions
    var div = _gel("previewDiv");
    var maxWidth = div.parentNode.offsetWidth;
    var maxHeight = defHeight;
    div.style.width = ((modulePrefs.width > maxWidth) ? maxWidth : modulePrefs.width) + 2 + "px";
    div.style.height = ((modulePrefs.height > maxHeight) ? maxHeight : modulePrefs.height) + 2 + "px";

    // Set syndicated gadget dimensions
    var iframe = _gel("previewFrame");
    iframe.style.width = modulePrefs.width + "px";
    iframe.style.height = modulePrefs.height + "px";

    return [
      "http://gmodules.com/ig/ifr?",
      "title=" + _esc(modulePrefs.title).replace(/%20/g, "+"),
      "w=" + modulePrefs.width,
      "h=" + modulePrefs.height,
      "synd=open",
      "nocache=1",
      "output=html"
    ].join("&");
  }

  function getGadgetSpec(id) {
    var spec = _gel(id).value;
    if (spec != "") {
      spec = spec.replace(/<br>/gi, "\n");
      spec = spec.replace(/&lt;/gi, "<");
      spec = spec.replace(/&gt;/gi, ">");
      spec = spec.replace(/&amp;/gi, ">");
    }
    return spec;
  }

  _IG_RegisterOnloadHandler(init);
  </script>

  ]]></Content>
</Module>
